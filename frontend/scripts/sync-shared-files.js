#!/usr/bin/env node

/**
 * This script synchronizes shared files between cloud-function and frontend.
 * It ensures that files that need to be identical are copied and validated.
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Define shared files configuration
// Each entry specifies the source (cloud-function) and destination (frontend)
const SHARED_FILES = [
  {
    source: 'cloud-function/src/lib/personalAccessToken.ts',
    destination: 'frontend/src/utils/personalAccessToken.ts',
    description: 'Personal Access Token utilities',
  },
];

const projectRoot = join(__dirname, '../..');

// Pattern to match warning comments at the beginning of shared files
const WARNING_PATTERN = /\/\/ âš ï¸.*?\n(?:\/\/.*?\n)*/;

// Function to generate the warning message for generated files
function generateWarningComment(sourceFile) {
  return `// âš ï¸ This file is automatically generated from ${sourceFile} âš ï¸
// Do not edit this file directly. Changes should be made to the source file.
// Run 'npm run sync:shared' in the frontend directory to regenerate this file.
`;
}

function syncFile(config) {
  const sourcePath = join(projectRoot, config.source);
  const destPath = join(projectRoot, config.destination);

  // Check if source file exists
  if (!existsSync(sourcePath)) {
    console.error(`âŒ Source file not found: ${config.source}`);
    process.exit(1);
  }

  // Read source file
  let sourceContent = readFileSync(sourcePath, 'utf8');

  // Update the warning comment to reflect the build process
  sourceContent = sourceContent.replace(
    WARNING_PATTERN,
    generateWarningComment(config.source),
  );

  // Write to destination
  writeFileSync(destPath, sourceContent, 'utf8');

  console.log(`âœ… Synced: ${config.description}`);
  console.log(`   ${config.source} â†’ ${config.destination}`);
}

function checkFile(config) {
  const sourcePath = join(projectRoot, config.source);
  const destPath = join(projectRoot, config.destination);

  // Check if both files exist
  if (!existsSync(sourcePath)) {
    console.error(`âŒ Source file not found: ${config.source}`);
    return false;
  }

  if (!existsSync(destPath)) {
    console.error(`âŒ Destination file not found: ${config.destination}`);
    console.log(`   Run 'npm run sync:shared' to generate it.`);
    return false;
  }

  // Read both files
  let sourceContent = readFileSync(sourcePath, 'utf8');
  const destContent = readFileSync(destPath, 'utf8');

  // Apply the same transformation that syncFile would apply
  const expectedContent = sourceContent.replace(
    WARNING_PATTERN,
    generateWarningComment(config.source),
  );

  if (expectedContent !== destContent) {
    console.error(`âŒ Files are out of sync: ${config.description}`);
    console.log(`   Run 'npm run sync:shared' to synchronize.`);
    return false;
  }

  console.log(`âœ… In sync: ${config.description}`);
  return true;
}

function main() {
  const args = process.argv.slice(2);
  const command = args[0];

  if (command === 'check') {
    console.log('ðŸ” Checking shared files synchronization...\n');

    let allInSync = true;
    SHARED_FILES.forEach((config) => {
      if (!checkFile(config)) {
        allInSync = false;
      }
    });

    if (!allInSync) {
      console.log('\nâŒ Some files are out of sync!');
      process.exit(1);
    }

    console.log('\nâœ¨ All shared files are synchronized!');
  } else {
    console.log('ðŸ”„ Synchronizing shared files...\n');

    SHARED_FILES.forEach((config) => {
      syncFile(config);
    });

    console.log('\nâœ¨ All shared files synchronized successfully!');
  }
}

main();
